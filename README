CGImap
======

Overview
--------

CGImap is a C++ implementation of the OpenStreetMap "map" call as an
FCGI process. The rails implementation of the "map" call has a few
problems with memory - it uses a lot of it and there is a leak which
makes it annoying to use in long-running environments, like the main
OSM server.

CGImap attempts to address these memory problems and makes it easier
to optimise the queries, something which is also a bit of a pain to do
in Rails.

Requirements
------------

CGImap depends on the following libraries. Versions used during
development are in brackets. Other versions may work, but YMMV.

* libxml2  (2.7.8.dfsg-5.1ubuntu4.4)
* libpqxx3 (3.1-1)
* libfcgi  (2.4.0-8.1)
* libboost (1.48.0.2)

If you're running a Debian or Ubuntu system these can be installed
using the following command:

    sudo apt-get install libxml2-dev libpqxx3-dev libfcgi-dev \
      libboost-dev libboost-regex-dev libboost-program-options-dev \
      libboost-date-time-dev libmemcached-dev

The build system used is GNU Make, using pkg-config to provide some of
the flags.

Note that the full set of packages needed from a fresh install (tested
with Ubuntu 13.04) - you may already have many or all of these - is:

    sudo apt-get install git build-essential automake autoconf

To build the system from scratch, first check out the source code (skip
this step if you've already got the source):

    git clone git://github.com/zerebubuth/openstreetmap-cgimap.git

Then change to the source code directory to configure and build:

    cd openstreetmap-cgimap/
    ./autogen.sh
    ./configure --with-fcgi=/usr
    make

You should now have a "./map" executable in the current directory.

Setup
-----

A sample lighttpd.conf file is provided, which I've been using to
test. No testing has been done with other FCGI servers, but if you
find a problem please report it on the OSM trac.

CGImap expects the following environment variables to be set:

* CGIMAP_HOST: Hostname or IP address of the database server.
* CGIMAP_NAME: Name of the database.
* CGIMAP_USER: Name of the user to connect as.
* CGIMAP_PASS: Password of the user to connect as.

Optionally, CGIMAP_CHARSET can be set to the connection charset to
use. The default is "utf8".

CGImap requires permissions to SELECT and CREATE TEMPORARY on the
Postgres server. It is recommended that a separate account is created for
CGImap to avoid any possibility of data corruption. Care has been
taken programming CGImap but, as with most C++ applications, there is
the chance of an exploitable flaw leading to complete pwnage.

Testing
-------

To run the test suite using `make check` you will need additional 
packages installed:

    sudo apt-get install postgresql postgresql-contrib ruby libxml-ruby \
      ruby-pg

And you will need to be able to create databases as your user:

    sudo -u postgres createuser $USER
    (say yes to superuser)

Acknowledgements
----------------

CGImap contains code from and is partly based on the following:

* modosmapi (http://code.google.com/p/modosmapi/) by
  d40cht and japplebyalis.
* quad_tile.c
  (http://svn.openstreetmap.org/sites/rails_port/db/functions/maptile.c)
  by TomH.
* GNU CGICC (http://www.gnu.org/software/cgicc/)
  by Stephen F. Booth and Sebastien Diaz.
